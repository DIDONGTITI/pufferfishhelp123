sequenceDiagram
  participant A as Alice
  participant AA as Alice's<br>agent
  participant AS as Alice's<br>server
  participant BS as Bob's<br>server
  participant BA as Bob's<br>agent
  participant B as Bob

  note over A, AA: 1. request connection from agent
  A ->> AA: NEW: create<br>duplex connection

  note over AA, AS: 2. create Alice's SMP queue
  AA ->> AS: NEW: create SMP queue
  AS ->> AA: IDS: SMP queue IDs

  A ->> AA: INVITE: invite<br>another party
  AA ->> A: JOIN: invitation<br>to connect

  note over A, B: 3. out-of-band invitation
  A ->> B: OOB: invitation to connect
  B ->> BA: CONNECT:<br>via invitation info

  note over BA, AA: 4. establish Alice's SMP queue
  BA ->> AS: SEND: KEY: sender's key and Bob's profile
  AS ->> AA: MSG: KEY: sender's key<br>and Bob's profile
  AA ->> A: Bob's profile<br>and party ID
  A ->> AA: ACCEPT:<br>accept party ID
  AA ->> AS: KEY: secure queue

  BA ->> AS: SEND: HI: try sending until successful
  AS ->> AA: MSG: HI: Alice's agent<br>knows Bob can send

  note over BA, BS: 5. create Bob's SMP queue
  BA ->> BS: NEW: create SMP queue
  BS ->> BA: IDS: SMP queue IDs

  note over AA, BA: 6. establish Bob's SMP queue
  BA ->> AS: SEND: REPLY: invitation to the connect
  AS ->> AA: MSG: REPLY: invitation<br>to connect

  AA ->> BS: SEND: KEY: sender's key and Alice's profile
  BS ->> BA: MSG: KEY: sender's key<br>and Alice's profile
  BA ->> BS: KEY: secure queue

  AA ->> BS: SEND: HI: try sending until successful
  BS ->> BA: MSG: HI: Bob's agent<br>knows Alice can send

  note over A, B: 7. notify users about connection success
  AA ->> A: CONNECTED
  BA ->> B: CONNECTED
